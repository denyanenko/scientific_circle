<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –∑–∞—è–≤–∫–∞–º–∏</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
<div class="container my-5">
    <h1 class="mb-4 text-center">üìã –£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –∑–∞—è–≤–∫–∞–º–∏</h1>
    <div id="applications" class="row g-3">
        <!-- –ó–∞—è–≤–∫–∏ –∑'—è–≤–ª—è—Ç—å—Å—è —Ç—É—Ç -->
    </div>
</div>

<script>
    async function fetchApplications() {
        try {
            const res = await fetch('/applications');
            const applications = await res.json();
            renderApplications(applications);
        } catch (err) {
            showAlert('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ –∑–∞—è–≤–æ–∫', 'danger');
            console.error(err);
        }
    }

    function renderApplications(applications) {
        const container = document.getElementById('applications');
        container.innerHTML = '';

        if (applications.length === 0) {
            const msg = document.createElement('div');
            msg.className = 'text-center text-muted';
            msg.textContent = '–ù–µ–º–∞—î –∞–∫—Ç–∏–≤–Ω–∏—Ö –∑–∞—è–≤–æ–∫.';
            container.appendChild(msg);
            return;
        }

        applications.forEach(app => {
            const fullName = `${app.lastName} ${app.firstName} ${app.patronymic || ''}`.trim();
            const date = new Date(app.applicationDate);
            const formattedDate = date.toLocaleString(undefined, {
                year: 'numeric',
                month: 'numeric',
                day: 'numeric',
                hour: 'numeric',
                minute: 'numeric',
            });

            const col = document.createElement('div');
            col.className = 'col-12 col-sm-6 col-md-6 col-lg-6';

            const card = document.createElement('div');
            card.className = 'card shadow-sm h-100';

            const cardBody = document.createElement('div');
            cardBody.className = 'card-body';

            const title = document.createElement('h5');
            title.className = 'card-title';
            title.textContent = fullName;

            const group = document.createElement('p');
            group.className = 'card-text';
            group.appendChild(strongText('–ì—Ä—É–ø–∞: ', app.studentGroup));

            const email = document.createElement('p');
            email.className = 'card-text';
            email.appendChild(strongText('Email: ', app.email));

            const appText = document.createElement('p');
            appText.className = 'card-text';
            const strong = document.createElement('strong');
            strong.textContent = '–ó–∞—è–≤–∫–∞:';
            appText.appendChild(strong);
            appText.appendChild(document.createElement('br'));
            appText.appendChild(document.createTextNode(app.applicationText));

            const dateText = document.createElement('p');
            dateText.className = 'card-text';
            const small = document.createElement('small');
            small.className = 'text-muted';
            small.textContent = `–î–∞—Ç–∞: ${formattedDate}`;
            dateText.appendChild(small);

            const buttons = document.createElement('div');
            buttons.className = 'd-flex justify-content-end gap-2';

            const acceptBtn = document.createElement('button');
            acceptBtn.className = 'btn btn-success btn-sm';
            acceptBtn.textContent = '‚úÖ –ü—Ä–∏–π–Ω—è—Ç–∏';
            acceptBtn.onclick = () => acceptApplication(app.id);

            const rejectBtn = document.createElement('button');
            rejectBtn.className = 'btn btn-danger btn-sm';
            rejectBtn.textContent = '‚ùå –í—ñ–¥—Ö–∏–ª–∏—Ç–∏';
            rejectBtn.onclick = () => rejectApplication(app.id);

            buttons.appendChild(acceptBtn);
            buttons.appendChild(rejectBtn);

            cardBody.append(title, group, email, appText, dateText, buttons);
            card.appendChild(cardBody);
            col.appendChild(card);
            container.appendChild(col);
        });

        // –¥–æ–ø–æ–º—ñ–∂–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è <strong>—Ç–µ–∫—Å—Ç: –∑–Ω–∞—á–µ–Ω–Ω—è</strong>
        function strongText(label, value) {
            const fragment = document.createDocumentFragment();
            const strong = document.createElement('strong');
            strong.textContent = label;
            fragment.appendChild(strong);
            fragment.appendChild(document.createTextNode(` ${value}`));
            return fragment;
        }
    }


    async function acceptApplication(id) {
        if (!confirm('–ü—Ä–∏–π–Ω—è—Ç–∏ —Ü—é –∑–∞—è–≤–∫—É?')) return;
        try {
            const res = await fetch(`/applications/${id}/accept`, { method: 'POST' });
            const result = await res.json();
            if (res.ok) {
                showAlert('–ó–∞—è–≤–∫—É –ø—Ä–∏–π–Ω—è—Ç–æ ‚úÖ');
                await fetchApplications();
            } else {
                showAlert(result.message || result.error, 'danger');
            }
        } catch (err) {
            showAlert('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –ø—Ä–∏–π–Ω—è—Ç—Ç—ñ –∑–∞—è–≤–∫–∏', 'danger');
            console.error(err);
        }
    }

    async function rejectApplication(id) {
        if (!confirm('–í—ñ–¥—Ö–∏–ª–∏—Ç–∏ —Ü—é –∑–∞—è–≤–∫—É?')) return;
        try {
            const res = await fetch(`/applications/${id}/reject`, { method: 'POST' });
            const result = await res.json();
            if (res.ok) {
                showAlert('–ó–∞—è–≤–∫—É –≤—ñ–¥—Ö–∏–ª–µ–Ω–æ ‚ùå');
                await fetchApplications();
            } else {
                showAlert(result.message || result.error, 'danger');
            }
        } catch (err) {
            showAlert('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≤—ñ–¥—Ö–∏–ª–µ–Ω–Ω—ñ –∑–∞—è–≤–∫–∏', 'danger');
            console.error(err);
        }
    }

    function showAlert(message, type = 'success') {
        const alert = document.createElement('div');
        alert.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3`;
        alert.style.zIndex = 9999;
        alert.setAttribute('role', 'alert');
        alert.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        document.body.appendChild(alert);
        setTimeout(() => alert.remove(), 4000);
    }

    // –ü–µ—Ä—à–∏–π –∑–∞–ø—É—Å–∫
    fetchApplications();
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="/js/layout.js"></script>
</body>
</html>
